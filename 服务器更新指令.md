# æœåŠ¡å™¨æ›´æ–°æŒ‡ä»¤

## ğŸ“‹ æœåŠ¡å™¨ä¿¡æ¯
- **IP åœ°å€**: 154.21.200.177
- **åŸŸå**: xfinds.cc
- **ç”¨æˆ·å**: root
- **åº”ç”¨ç«¯å£**: 8000
- **HTTPS**: https://xfinds.cc

---

## âš¡ æ–¹æ³•ä¸€ï¼šå¿«é€Ÿæ›´æ–°ï¼ˆæ¨èç”¨äºæ—¥å¸¸æ›´æ–°ï¼‰

é€‚ç”¨äºå·²æœ‰éƒ¨ç½²ï¼Œåªéœ€æ›´æ–°ä»£ç çš„æƒ…å†µã€‚

### æ­¥éª¤ 1ï¼šè¿æ¥åˆ°æœåŠ¡å™¨
```bash
ssh root@154.21.200.177
```

### æ­¥éª¤ 2ï¼šæ‰§è¡Œå¿«é€Ÿæ›´æ–°
```bash
cd /var/www/xfinds && git pull origin main && chmod +x scripts/deploy/quick-update.sh && ./scripts/deploy/quick-update.sh
```

**æˆ–è€…åˆ†æ­¥æ‰§è¡Œ**ï¼š
```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /var/www/xfinds

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# æ‰§è¡Œå¿«é€Ÿæ›´æ–°è„šæœ¬
chmod +x scripts/deploy/quick-update.sh
./scripts/deploy/quick-update.sh
```

**å¿«é€Ÿæ›´æ–°è„šæœ¬åŠŸèƒ½**ï¼š
- âœ… æ‹‰å–æœ€æ–°ä»£ç 
- âœ… æ¸…ç†æ„å»ºç¼“å­˜ï¼ˆé¢„é˜² Sharp é”™è¯¯ï¼‰
- âœ… å®‰è£…ä¾èµ–æ›´æ–°
- âœ… é‡æ–°æ„å»ºé¡¹ç›®
- âœ… é‡å¯ PM2 åº”ç”¨
- âœ… éªŒè¯éƒ¨ç½²çŠ¶æ€

---

## ğŸ”„ æ–¹æ³•äºŒï¼šå®Œæ•´éƒ¨ç½²ï¼ˆç”¨äºé¦–æ¬¡éƒ¨ç½²æˆ–å®Œå…¨é‡ç½®ï¼‰

é€‚ç”¨äºé¦–æ¬¡éƒ¨ç½²æˆ–éœ€è¦å®Œå…¨é‡ç½®çš„æƒ…å†µã€‚

### æ­¥éª¤ 1ï¼šè¿æ¥åˆ°æœåŠ¡å™¨
```bash
ssh root@154.21.200.177
```

### æ­¥éª¤ 2ï¼šæ‰§è¡Œå®Œæ•´éƒ¨ç½²è„šæœ¬

**æ–¹å¼ Aï¼šä½¿ç”¨ GitHub Tokenï¼ˆæ¨èï¼‰**

åœ¨æœåŠ¡å™¨ä¸Šç›´æ¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
cat > /root/deploy-from-github.sh << 'SCRIPT_END'
#!/bin/bash
set -e

PROJECT_DIR="/var/www/xfinds"
GITHUB_TOKEN="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"
GITHUB_REPO_AUTH="https://${GITHUB_TOKEN}@github.com/TheNewMikeMusic/Xfinds.git"
BRANCH="main"
BACKUP_DIR="/var/www/xfinds-backup-$(date +%Y%m%d-%H%M%S)"

echo "=========================================="
echo "ä» GitHub æ‹‰å–å¹¶éƒ¨ç½² Xfindsï¼ˆä½¿ç”¨ Token è®¤è¯ï¼‰"
echo "åŸŸå: xfinds.cc | ç«¯å£: 8000 | HTTPS: Let's Encrypt"
echo "=========================================="

echo ""
echo "=== åœæ­¢ PM2 è¿›ç¨‹ ==="
pm2 stop xfinds 2>/dev/null || true
pm2 delete xfinds 2>/dev/null || true

if [ -d "$PROJECT_DIR" ]; then
    echo ""
    echo "=== å¤‡ä»½ç°æœ‰é¡¹ç›® ==="
    mkdir -p "$BACKUP_DIR"
    if [ -f "$PROJECT_DIR/.env.local" ]; then
        cp "$PROJECT_DIR/.env.local" "$BACKUP_DIR/.env.local.backup"
        echo "å·²å¤‡ä»½ .env.local"
    fi
    cp -r "$PROJECT_DIR" "$BACKUP_DIR/project" 2>/dev/null || true
    echo "å¤‡ä»½å®Œæˆ"
fi

echo ""
echo "=== æ¸…ç†ç°æœ‰é¡¹ç›® ==="
rm -rf "$PROJECT_DIR"
mkdir -p "$PROJECT_DIR"

echo ""
echo "=== ä» GitHub æ‹‰å–æœ€æ–°ä»£ç ï¼ˆä½¿ç”¨ Token è®¤è¯ï¼‰ ==="
cd "$PROJECT_DIR"
git clone "$GITHUB_REPO_AUTH" .

echo ""
echo "=== åˆ‡æ¢åˆ° $BRANCH åˆ†æ”¯ ==="
git checkout "$BRANCH"
git pull origin "$BRANCH"

if [ -f "$BACKUP_DIR/.env.local.backup" ]; then
    echo ""
    echo "=== æ¢å¤ç¯å¢ƒå˜é‡é…ç½® ==="
    cp "$BACKUP_DIR/.env.local.backup" "$PROJECT_DIR/.env.local"
    sed -i 's|APP_URL=.*|APP_URL=https://xfinds.cc|' .env.local
    sed -i 's|NEXT_PUBLIC_APP_URL=.*|NEXT_PUBLIC_APP_URL=https://xfinds.cc|' .env.local
    echo "å·²æ¢å¤å¹¶æ›´æ–° .env.local"
else
    echo ""
    echo "=== åˆ›å»ºæ–°çš„ç¯å¢ƒå˜é‡é…ç½® ==="
    JWT_SECRET=$(openssl rand -base64 32)
    cat > .env.local << EOF
NODE_ENV=production
JWT_SECRET=${JWT_SECRET}
AUTH_MODE=stub
APP_URL=https://xfinds.cc
NEXT_PUBLIC_APP_URL=https://xfinds.cc
EXCHANGE_RATE_API=https://api.exchangerate-api.com/v4/latest/CNY
EOF
    echo "å·²åˆ›å»ºæ–°çš„ .env.local"
fi

echo ""
echo "=== æ¸…ç†æ„å»ºå’Œç¼“å­˜ï¼ˆé¢„é˜² Sharp é”™è¯¯ï¼‰ ==="
rm -rf .next
rm -rf node_modules/.cache

echo ""
echo "=== å®‰è£…ä¾èµ– ==="
npm install

echo ""
echo "=== ç¡®ä¿ Sharp æ­£ç¡®å®‰è£…ï¼ˆé¢„é˜²å›¾ç‰‡ä¼˜åŒ–é”™è¯¯ï¼‰ ==="
npm install sharp@latest --force || echo "Sharp å®‰è£…è­¦å‘Šï¼Œç»§ç»­..."

echo ""
echo "=== æ„å»ºé¡¹ç›® ==="
npm run build

# éªŒè¯æ„å»ºæ˜¯å¦æˆåŠŸ
if [ ! -d ".next" ]; then
    echo "âŒ é”™è¯¯: æ„å»ºå¤±è´¥ï¼Œ.next ç›®å½•ä¸å­˜åœ¨"
    exit 1
fi

echo ""
echo "=== ä½¿ç”¨ PM2 ç”Ÿæ€ç³»ç»Ÿé…ç½®å¯åŠ¨åº”ç”¨ ==="
if [ -f "ecosystem.config.js" ]; then
    echo "ä½¿ç”¨ ecosystem.config.js é…ç½®å¯åŠ¨..."
    pm2 start ecosystem.config.js
else
    echo "ä½¿ç”¨ä¼ ç»Ÿæ–¹å¼å¯åŠ¨..."
    pm2 start npm --name "xfinds" -- start
fi

pm2 save
pm2 startup | tail -1 | bash || true

echo ""
echo "=== ç­‰å¾…åº”ç”¨å¯åŠ¨å¹¶éªŒè¯ ==="
sleep 5

# æ£€æŸ¥åº”ç”¨çŠ¶æ€
if pm2 list | grep -q "xfinds.*online"; then
    echo "âœ… åº”ç”¨å·²å¯åŠ¨"
else
    echo "âš ï¸  åº”ç”¨å¯èƒ½æœªæ­£å¸¸å¯åŠ¨ï¼Œæ£€æŸ¥æ—¥å¿—..."
    pm2 logs xfinds --lines 20 --nostream
    exit 1
fi

# æ£€æŸ¥ç«¯å£ç›‘å¬
if netstat -tulpn 2>/dev/null | grep -q ":8000" || ss -tulpn 2>/dev/null | grep -q ":8000"; then
    echo "âœ… ç«¯å£ 8000 æ­£åœ¨ç›‘å¬"
else
    echo "âš ï¸  ç«¯å£ 8000 æœªç›‘å¬ï¼Œæ£€æŸ¥åº”ç”¨æ—¥å¿—..."
    pm2 logs xfinds --lines 30 --nostream
    exit 1
fi

# æµ‹è¯•æœ¬åœ°è¿æ¥
if curl -f -s -o /dev/null -w "%{http_code}" http://localhost:8000 | grep -q "200\|301\|302\|307"; then
    echo "âœ… æœ¬åœ°è¿æ¥æµ‹è¯•æˆåŠŸ"
else
    echo "âš ï¸  æœ¬åœ°è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­..."
fi

echo ""
echo "=== é…ç½®é˜²ç«å¢™ ==="
ufw allow 8000/tcp 2>/dev/null || firewall-cmd --permanent --add-port=8000/tcp 2>/dev/null || true
ufw allow 80/tcp 2>/dev/null || firewall-cmd --permanent --add-port=80/tcp 2>/dev/null || true
ufw allow 443/tcp 2>/dev/null || firewall-cmd --permanent --add-port=443/tcp 2>/dev/null || true
firewall-cmd --reload 2>/dev/null || true

echo ""
echo "=== é…ç½® Nginx ==="
if [ ! -f /etc/nginx/sites-available/xfinds ]; then
    echo "å¤åˆ¶ Nginx é…ç½®æ–‡ä»¶..."
    cp nginx.conf /etc/nginx/sites-available/xfinds
fi

if [ ! -L /etc/nginx/sites-enabled/xfinds ]; then
    echo "å¯ç”¨ Nginx ç«™ç‚¹..."
    ln -s /etc/nginx/sites-available/xfinds /etc/nginx/sites-enabled/
fi

echo "æµ‹è¯• Nginx é…ç½®..."
nginx -t && systemctl reload nginx || echo "Nginx é…ç½®æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®"

echo ""
echo ""
echo "=== æœ€ç»ˆéªŒè¯ ==="
pm2 status
echo ""
echo "åº”ç”¨æ—¥å¿—ï¼ˆæœ€å 10 è¡Œï¼‰ï¼š"
pm2 logs xfinds --lines 10 --nostream || true

echo ""
echo "=========================================="
echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "=========================================="
echo "è®¿é—®åœ°å€: https://xfinds.cc"
echo "å¤‡ä»½ä½ç½®: $BACKUP_DIR"
echo ""
echo "åº”ç”¨çŠ¶æ€:"
pm2 list | grep xfinds || echo "æœªæ‰¾åˆ° xfinds è¿›ç¨‹"
echo ""
echo "å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š"
echo "  - pm2 logs xfinds"
echo "  - tail -50 /var/log/nginx/xfinds-error.log"
echo ""
echo "è¿è¡ŒéªŒè¯è„šæœ¬ï¼š"
echo "  chmod +x scripts/deploy/verify-deployment.sh"
echo "  ./scripts/deploy/verify-deployment.sh"
echo "=========================================="
SCRIPT_END

chmod +x /root/deploy-from-github.sh
/root/deploy-from-github.sh
```

**æ–¹å¼ Bï¼šä½¿ç”¨é¡¹ç›®ä¸­çš„éƒ¨ç½²è„šæœ¬**

å¦‚æœé¡¹ç›®å·²ç»å­˜åœ¨ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨é¡¹ç›®ä¸­çš„è„šæœ¬ï¼š

```bash
cd /var/www/xfinds
chmod +x scripts/deploy/deploy-from-github-with-token.sh
./scripts/deploy/deploy-from-github-with-token.sh
```

---

## âœ… éƒ¨ç½²åéªŒè¯

### æ£€æŸ¥åº”ç”¨çŠ¶æ€
```bash
# æŸ¥çœ‹ PM2 çŠ¶æ€
pm2 status

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
pm2 logs xfinds --lines 20

# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tulpn | grep 8000
# æˆ–
ss -tulpn | grep 8000

# æµ‹è¯•æœ¬åœ°è¿æ¥
curl -I http://localhost:8000
```

### è¿è¡ŒéªŒè¯è„šæœ¬
```bash
cd /var/www/xfinds
chmod +x scripts/deploy/verify-deployment.sh
./scripts/deploy/verify-deployment.sh
```

### è®¿é—®åº”ç”¨
- **HTTPS**: https://xfinds.cc
- **HTTP**: http://xfinds.ccï¼ˆä¼šè‡ªåŠ¨è·³è½¬åˆ° HTTPSï¼‰

---

## ğŸ”§ å¸¸ç”¨ç®¡ç†å‘½ä»¤

### PM2 å‘½ä»¤
```bash
# æŸ¥çœ‹åº”ç”¨çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs xfinds

# æŸ¥çœ‹æœ€è¿‘ 20 è¡Œæ—¥å¿—
pm2 logs xfinds --lines 20

# é‡å¯åº”ç”¨
pm2 restart xfinds

# åœæ­¢åº”ç”¨
pm2 stop xfinds

# åˆ é™¤åº”ç”¨
pm2 delete xfinds
```

### Nginx å‘½ä»¤
```bash
# æ£€æŸ¥ Nginx é…ç½®
nginx -t

# é‡æ–°åŠ è½½ Nginx
systemctl reload nginx

# æŸ¥çœ‹ Nginx çŠ¶æ€
systemctl status nginx

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/xfinds-error.log
```

---

## ğŸš¨ æ•…éšœæ’æŸ¥

### åº”ç”¨æ— æ³•å¯åŠ¨
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
pm2 logs xfinds --lines 50

# æ£€æŸ¥ç¯å¢ƒå˜é‡
cat /var/www/xfinds/.env.local

# æ£€æŸ¥ Node.js ç‰ˆæœ¬
node -v  # éœ€è¦ 18+ æˆ– 20+

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h
```

### æ„å»ºå¤±è´¥
```bash
# æ¸…ç†å¹¶é‡æ–°å®‰è£…
cd /var/www/xfinds
rm -rf .next node_modules
npm install
npm run build
```

### ç«¯å£è¢«å ç”¨
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -tulpn | grep 8000
# æˆ–
lsof -i :8000

# æ€æ­»å ç”¨è¿›ç¨‹
kill -9 <PID>
```

### ä»å¤‡ä»½æ¢å¤
```bash
# æŸ¥çœ‹å¤‡ä»½ç›®å½•
ls -la /var/www/xfinds-backup-*

# æ¢å¤é¡¹ç›®
cp -r /var/www/xfinds-backup-æœ€æ–°æ—¶é—´æˆ³/project/* /var/www/xfinds/
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½**ï¼šå®Œæ•´éƒ¨ç½²è„šæœ¬ä¼šè‡ªåŠ¨å¤‡ä»½ç°æœ‰é¡¹ç›®åˆ° `/var/www/xfinds-backup-æ—¶é—´æˆ³/`
2. **ç¯å¢ƒå˜é‡**ï¼šå¦‚æœå­˜åœ¨ `.env.local`ï¼Œä¼šè‡ªåŠ¨æ¢å¤ï¼›å¦åˆ™ä¼šåˆ›å»ºæ–°çš„
3. **å®Œå…¨æ›¿æ¢**ï¼šå®Œæ•´éƒ¨ç½²è„šæœ¬ä¼šå®Œå…¨åˆ é™¤æ—§é¡¹ç›®å¹¶ä» GitHub é‡æ–°å…‹éš†
4. **å¿«é€Ÿæ›´æ–°**ï¼šå¿«é€Ÿæ›´æ–°è„šæœ¬åªæ›´æ–°ä»£ç ï¼Œä¸ä¼šåˆ é™¤é¡¹ç›®ç›®å½•
5. **GitHub Token**ï¼šç¡®ä¿ GitHub Token æœ‰æ•ˆä¸”æœ‰è®¿é—®ä»“åº“çš„æƒé™

---

## ğŸ¯ æ¨èä½¿ç”¨åœºæ™¯

- **æ—¥å¸¸ä»£ç æ›´æ–°** â†’ ä½¿ç”¨ **å¿«é€Ÿæ›´æ–°**ï¼ˆæ–¹æ³•ä¸€ï¼‰
- **é¦–æ¬¡éƒ¨ç½²** â†’ ä½¿ç”¨ **å®Œæ•´éƒ¨ç½²**ï¼ˆæ–¹æ³•äºŒï¼‰
- **éœ€è¦é‡ç½®ç¯å¢ƒ** â†’ ä½¿ç”¨ **å®Œæ•´éƒ¨ç½²**ï¼ˆæ–¹æ³•äºŒï¼‰
- **ä¾èµ–åŒ…æ›´æ–°** â†’ ä½¿ç”¨ **å¿«é€Ÿæ›´æ–°**ï¼ˆæ–¹æ³•ä¸€ï¼‰
