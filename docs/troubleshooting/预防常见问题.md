# 预防常见部署问题

本文档说明如何预防常见的部署问题，包括 502 Bad Gateway 和 Sharp 图片优化错误。

## 预防措施

### 1. 使用 PM2 生态系统配置

项目包含 `ecosystem.config.js` 文件，配置了：
- 自动重启（`autorestart: true`）
- 内存限制重启（`max_memory_restart: '1G'`）
- 重启策略（`min_uptime`, `max_restarts`, `restart_delay`）
- 日志配置

**使用方法**：
```bash
pm2 start ecosystem.config.js
```

### 2. 部署脚本中的预防措施

部署脚本 (`scripts/deploy/deploy-from-github.sh`) 已包含以下预防措施：

#### 预防 502 Bad Gateway：
- ✅ 清理构建缓存（`rm -rf .next`）
- ✅ 验证构建成功（检查 `.next` 目录）
- ✅ 启动后验证应用状态（检查 PM2 状态）
- ✅ 验证端口监听（检查端口 8000）
- ✅ 测试本地连接（`curl http://localhost:8000`）

#### 预防 Sharp 错误：
- ✅ 清理 Sharp 缓存（`rm -rf node_modules/.cache`）
- ✅ 强制重新安装 Sharp（`npm install sharp@latest --force`）
- ✅ 清理构建文件后重新构建

### 3. 部署后验证脚本

使用 `scripts/deploy/verify-deployment.sh` 验证部署：

```bash
chmod +x scripts/deploy/verify-deployment.sh
./scripts/deploy/verify-deployment.sh
```

验证脚本会检查：
- PM2 应用状态
- 端口监听状态
- 本地连接测试
- 构建文件存在性
- Nginx 配置正确性
- 应用错误日志
- Sharp 相关错误

### 4. PM2 自动重启配置

`ecosystem.config.js` 已配置：
- **自动重启**：应用崩溃后自动重启
- **内存限制**：超过 1GB 自动重启
- **重启延迟**：4 秒后重启，避免频繁重启
- **最小运行时间**：至少运行 10 秒才算成功启动
- **最大重启次数**：最多重启 10 次

### 5. 定期维护

建议定期执行以下维护：

```bash
cd /var/www/xfinds

# 1. 检查应用状态
pm2 status

# 2. 查看日志
pm2 logs xfinds --lines 50

# 3. 检查端口监听
netstat -tulpn | grep 8000

# 4. 测试本地连接
curl -I http://localhost:8000

# 5. 如果发现 Sharp 错误，执行修复
pm2 stop xfinds
rm -rf .next node_modules/.cache
npm install sharp@latest --force
npm run build
pm2 restart xfinds
```

## 常见问题预防清单

### ✅ 部署前检查：
- [ ] 确保 GitHub Token 有效
- [ ] 确保域名 DNS 解析正确
- [ ] 确保服务器有足够空间（至少 2GB 可用）

### ✅ 部署时检查：
- [ ] 构建成功（`.next` 目录存在）
- [ ] 依赖安装成功（无错误）
- [ ] Sharp 正确安装
- [ ] PM2 应用状态为 `online`
- [ ] 端口 8000 正在监听
- [ ] 本地连接测试成功

### ✅ 部署后检查：
- [ ] 运行验证脚本
- [ ] 检查应用日志（无错误）
- [ ] 测试 HTTPS 访问
- [ ] 检查 Nginx 错误日志

## 自动监控建议

可以设置定时任务（cron）自动检查：

```bash
# 编辑 crontab
crontab -e

# 添加以下行（每小时检查一次）
0 * * * * cd /var/www/xfinds && pm2 status | grep -q "xfinds.*online" || (pm2 restart xfinds && echo "$(date): Restarted xfinds" >> /var/log/xfinds-monitor.log)
```

## 快速修复命令

如果遇到问题，可以使用以下快速修复：

```bash
cd /var/www/xfinds

# 完整重启流程
pm2 stop xfinds
rm -rf .next node_modules/.cache
npm install sharp@latest --force
npm run build
pm2 restart xfinds
sleep 5
pm2 status
curl -I http://localhost:8000
```

## 相关文档

- [修复 502 Bad Gateway 错误](./修复502错误.md)
- [修复图片优化错误](./修复图片优化错误.md)
- [部署文档](../DEPLOY.md)

